/**
 * @file Firebase Security Rules for AIPerform Firestore Database
 *
 * @corePhilosophy This ruleset enforces a strict user-ownership model, ensuring that only the authenticated user can access their own data.
 * @dataStructure All data is nested under /users/{userId}, with interview sessions and related data organized as subcollections.
 * @keySecurityDecisions Path-based ownership is the primary security mechanism, eliminating the need for get() calls and simplifying rules. Listing operations are restricted to the owner of the user ID in the path. Write operations are only permitted if the authenticated user ID matches the user ID in the document path.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secures the user profiles collection, ensuring only the user can read or write their own profile.
     * @path /users/{userId}
     * @allow (create) - Authenticated user creates their own profile with matching userId.
     * @allow (get, list, update, delete) - Authenticated user accesses their own profile with matching userId.
     * @deny (create, get, list, update, delete) - Any other user attempts to access this profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      // Allow the user to create their own profile if the userId matches their auth uid.
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;

      // Allow the user to read their own profile.
      allow get: if isOwner(userId);
      allow list: if false;

      // Allow the user to update their own profile.
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;

      // Allow the user to delete their own profile.
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secures interview sessions for each user, enforcing path-based ownership.
     * @path /users/{userId}/interviewSessions/{interviewSessionId}
     * @allow (create) - Authenticated user creates a new interview session under their own userId.
     * @allow (get, list, update, delete) - Authenticated user accesses their own interview sessions.
     * @deny (create, get, list, update, delete) - Any other user attempts to access this interview session.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/interviewSessions/{interviewSessionId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      // Allow the user to create a new interview session under their own userId.
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;

      // Allow the user to read their own interview sessions.
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      // Allow the user to update their own interview sessions.
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;

      // Allow the user to delete their own interview sessions.
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secures aptitude round data for a specific interview session, enforcing path-based ownership.
     * @path /users/{userId}/interviewSessions/{interviewSessionId}/aptitudeRounds/{aptitudeRoundId}
     * @allow (create) - Authenticated user creates aptitude round data under their own userId and interviewSessionId.
     * @allow (get, list, update, delete) - Authenticated user accesses their own aptitude round data.
     * @deny (create, get, list, update, delete) - Any other user attempts to access this aptitude round data.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/interviewSessions/{interviewSessionId}/aptitudeRounds/{aptitudeRoundId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      // Allow the user to create aptitude round data under their own userId and interviewSessionId.
      allow create: if isSignedIn() && isOwner(userId) && get(/databases/$(database)/documents/users/$(userId)/interviewSessions/$(interviewSessionId)).data.userId == userId;

      // Allow the user to read their own aptitude round data.
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      // Allow the user to update their own aptitude round data.
      allow update: if isExistingOwner(userId) && get(/databases/$(database)/documents/users/$(userId)/interviewSessions/$(interviewSessionId)).data.userId == userId;

      // Allow the user to delete their own aptitude round data.
      allow delete: if isExistingOwner(userId) && get(/databases/$(database)/documents/users/$(userId)/interviewSessions/$(interviewSessionId)).data.userId == userId;
    }

    /**
     * @description Secures coding round data for a specific interview session, enforcing path-based ownership.
     * @path /users/{userId}/interviewSessions/{interviewSessionId}/codingRounds/{codingRoundId}
     * @allow (create) - Authenticated user creates coding round data under their own userId and interviewSessionId.
     * @allow (get, list, update, delete) - Authenticated user accesses their own coding round data.
     * @deny (create, get, list, update, delete) - Any other user attempts to access this coding round data.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/interviewSessions/{interviewSessionId}/codingRounds/{codingRoundId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      // Allow the user to create coding round data under their own userId and interviewSessionId.
      allow create: if isSignedIn() && isOwner(userId) && get(/databases/$(database)/documents/users/$(userId)/interviewSessions/$(interviewSessionId)).data.userId == userId;

      // Allow the user to read their own coding round data.
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      // Allow the user to update their own coding round data.
      allow update: if isExistingOwner(userId) && get(/databases/$(database)/documents/users/$(userId)/interviewSessions/$(interviewSessionId)).data.userId == userId;

      // Allow the user to delete their own coding round data.
      allow delete: if isExistingOwner(userId) && get(/databases/$(database)/documents/users/$(userId)/interviewSessions/$(interviewSessionId)).data.userId == userId;
    }

    /**
     * @description Secures HR round data for a specific interview session, enforcing path-based ownership.
     * @path /users/{userId}/interviewSessions/{interviewSessionId}/hrRounds/{hrRoundId}
     * @allow (create) - Authenticated user creates HR round data under their own userId and interviewSessionId.
     * @allow (get, list, update, delete) - Authenticated user accesses their own HR round data.
     * @deny (create, get, list, update, delete) - Any other user attempts to access this HR round data.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/interviewSessions/{interviewSessionId}/hrRounds/{hrRoundId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      // Allow the user to create HR round data under their own userId and interviewSessionId.
      allow create: if isSignedIn() && isOwner(userId) && get(/databases/$(database)/documents/users/$(userId)/interviewSessions/$(interviewSessionId)).data.userId == userId;

      // Allow the user to read their own HR round data.
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      // Allow the user to update their own HR round data.
      allow update: if isExistingOwner(userId) && get(/databases/$(database)/documents/users/$(userId)/interviewSessions/$(interviewSessionId)).data.userId == userId;

      // Allow the user to delete their own HR round data.
      allow delete: if isExistingOwner(userId) && get(/databases/$(database)/documents/users/$(userId)/interviewSessions/$(interviewSessionId)).data.userId == userId;
    }

    /**
     * @description Secures feedback reports for a specific interview session, enforcing path-based ownership.
     * @path /users/{userId}/interviewSessions/{interviewSessionId}/feedbackReports/{feedbackReportId}
     * @allow (create) - Authenticated user creates a feedback report under their own userId and interviewSessionId.
     * @allow (get, list, update, delete) - Authenticated user accesses their own feedback reports.
     * @deny (create, get, list, update, delete) - Any other user attempts to access this feedback report.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/interviewSessions/{interviewSessionId}/feedbackReports/{feedbackReportId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      // Allow the user to create a feedback report under their own userId and interviewSessionId.
      allow create: if isSignedIn() && isOwner(userId) && get(/databases/$(database)/documents/users/$(userId)/interviewSessions/$(interviewSessionId)).data.userId == userId;

      // Allow the user to read their own feedback reports.
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      // Allow the user to update their own feedback reports.
      allow update: if isExistingOwner(userId) && get(/databases/$(database)/documents/users/$(userId)/interviewSessions/$(interviewSessionId)).data.userId == userId;

      // Allow the user to delete their own feedback reports.
      allow delete: if isExistingOwner(userId) && get(/databases/$(database)/documents/users/$(userId)/interviewSessions/$(interviewSessionId)).data.userId == userId;
    }

    /**
     * @description Secures screen recordings for a specific interview session, enforcing path-based ownership.
     * @path /users/{userId}/interviewSessions/{interviewSessionId}/screenRecordings/{screenRecordingId}
     * @allow (create) - Authenticated user creates a screen recording under their own userId and interviewSessionId.
     * @allow (get, list, update, delete) - Authenticated user accesses their own screen recordings.
     * @deny (create, get, list, update, delete) - Any other user attempts to access this screen recording.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/interviewSessions/{interviewSessionId}/screenRecordings/{screenRecordingId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      // Allow the user to create a screen recording under their own userId and interviewSessionId.
      allow create: if isSignedIn() && isOwner(userId) && get(/databases/$(database)/documents/users/$(userId)/interviewSessions/$(interviewSessionId)).data.userId == userId;

      // Allow the user to read their own screen recordings.
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      // Allow the user to update their own screen recordings.
      allow update: if isExistingOwner(userId) && get(/databases/$(database)/documents/users/$(userId)/interviewSessions/$(interviewSessionId)).data.userId == userId;

      // Allow the user to delete their own screen recordings.
      allow delete: if isExistingOwner(userId) && get(/databases/$(database)/documents/users/$(userId)/interviewSessions/$(interviewSessionId)).data.userId == userId;
    }
  }
}